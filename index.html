<script type="text/javascript">
    const URL = "https://teachablemachine.withgoogle.com/models/FZXHT2jEt/";

    let model, webcam, labelContainer, maxPredictions;

    // ▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼
    // 여기 이름들을 '잠시 후 화면에 뜨는 이름'과 똑같이 맞춰야 합니다.
    // ▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼
    const buildingInfo = {
        "Class 1": "이곳은 강의실/도서관으로 가는 길입니다.",
        "Class 2": "여기는 다른 건물입니다." 
    };

    const buildingLinks = {
        "Class 1": "https://rkddmltlf.github.io/4",
        "Class 2": "https://www.naver.com"
    };

    let currentLink = "";

    async function init() {
        const modelURL = URL + "model.json";
        const metadataURL = URL + "metadata.json";

        model = await tmImage.load(modelURL, metadataURL);
        maxPredictions = model.getTotalClasses();

        const flip = false; 
        webcam = new tmImage.Webcam(300, 300, flip); 
        await webcam.setup({ facingMode: "environment" }); 
        await webcam.play();
        window.requestAnimationFrame(loop);

        document.getElementById("webcam-container").appendChild(webcam.canvas);
        document.querySelector("button").style.display = "none";
        
        // 클릭 이벤트
        document.getElementById("info-container").addEventListener("click", function() {
            if (currentLink) {
                window.location.href = currentLink;
            } else {
                alert("링크가 없는 건물입니다.");
            }
        });
    }

    async function loop() {
        webcam.update(); 
        await predict();
        window.requestAnimationFrame(loop);
    }

    async function predict() {
        const prediction = await model.predict(webcam.canvas);
        
        let highestProp = 0;
        let bestClassName = "";

        for (let i = 0; i < maxPredictions; i++) {
            if (prediction[i].probability > highestProp) {
                highestProp = prediction[i].probability;
                bestClassName = prediction[i].className;
            }
        }

        const infoDiv = document.getElementById("info-container");
        const nameDiv = document.getElementById("result-name");
        const descDiv = document.getElementById("result-desc");
        const linkMsgDiv = document.getElementById("link-msg");
        const scoreDiv = document.getElementById("result-score");

        // ★ 테스트를 위해 확률을 0.85에서 0.50으로 낮춤 (더 잘 뜨게)
        if (highestProp > 0.50) {
            infoDiv.style.display = "block";
            
            // ★ 화면에 정확한 클래스 이름을 보여줍니다 (이걸 보고 수정하세요!)
            nameDiv.innerText = "인식됨: [" + bestClassName + "]";
            
            // buildingInfo에 해당 이름이 있는지 확인
            if(buildingInfo[bestClassName]) {
                descDiv.innerText = buildingInfo[bestClassName];
                descDiv.style.color = "#555"; // 정상 색상
            } else {
                // 이름이 안 맞을 경우 경고 메시지 출력
                descDiv.innerText = "⚠️ 코드를 수정하세요!\n buildingInfo에 '" + bestClassName + "'을(를) 추가해야 합니다.";
                descDiv.style.color = "red"; // 빨간색 경고
            }

            // 링크 연결 로직
            if (buildingLinks[bestClassName]) {
                currentLink = buildingLinks[bestClassName]; 
                infoDiv.classList.add("clickable"); 
                linkMsgDiv.style.display = "block";
            } else {
                currentLink = ""; 
                infoDiv.classList.remove("clickable");
                linkMsgDiv.style.display = "none";
            }

            scoreDiv.innerText = "정확도: " + (highestProp * 100).toFixed(1) + "%";
        }
    }
</script>